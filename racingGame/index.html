<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tennis Game</title>
</head>
<body>
  <canvas id="gameCanvas" width="815" height="590"></canvas>
  <script>
    var canvas;
    var canvasContext;

    // Car's settings
    var carPic = document.createElement("img");
    var carPicLoaded = false;

    var carX;
    var carY;
    var carAng = 0;
    var carSpeed = 3;

    // Track's settings
    const TRACK_WIDTH = 40;
    const TRACK_HEIGHT = 40;
    const TRACK_GAP = 5;
    const TRACK_COLS = 18;
    const TRACK_ROWS = 13;
    var trackGrid = [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
                      1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1,
                      1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1,
                      1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
                      1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1,
                      1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1,
                      1, 0, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1,
                      1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1,
                      1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1,
                      1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ];
    var tracksLeft = 0;

    // Mouse settings
    var mouseX = 400;
    var mouseY;

    window.onload = function() {
      // save the canvas for dimensions, and its 2d context for drawing to it
      canvas = document.getElementById("gameCanvas");
      canvasContext = canvas.getContext('2d');

      carReset();

      canvas.addEventListener('mousemove', updateMousePos);

      carPic.onload = function() {
        carPicLoaded = true;
      }
      carPic.src = "player_1.png";

      var fps = 30;
      setInterval(updateAll, 1000 / fps);
    }

    function updateAll() {
      drawEverything();
      moveEverything();
    };

    function carReset() {
      for (var row = 1; row <= TRACK_ROWS; row++) {
        for (var col = 1; col <= TRACK_COLS; col++) {
          var arrayIndex = colRowToArrayIndex(col, row);
          if ( trackGrid[arrayIndex] == 2 ) {
            trackGrid[arrayIndex] = 0;
            carX = (TRACK_WIDTH + TRACK_GAP) * (col - 1) + TRACK_WIDTH / 2 + TRACK_GAP;
            carY = (TRACK_HEIGHT + TRACK_GAP) * (row - 1) + TRACK_HEIGHT / 2 + TRACK_GAP;
          }
        }
      }
    }

    function updateMousePos(event) {
       var rect = canvas.getBoundingClientRect();
       var root = document.documentElement;

       mouseX = event.clientX - rect.left - root.scrollLeft
       mouseY = event.clientY - rect.top - root.scrollTop;

       // cheat / to check for bugs 
       /*
       carX = mouseX;
       carY = mouseY;
       */
    }

    function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
      canvasContext.fillStyle = fillColor;
      canvasContext.beginPath();
      canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
      canvasContext.fill();
    }

    function colorCircle(centerX, centerY, radius, fillColor) {
      canvasContext.fillStyle = fillColor;
      canvasContext.beginPath();
      canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
      canvasContext.fill();
    }

    function colorText(showText, textX, textY, fillColor) {
      canvasContext.fillStyle = fillColor;
      canvasContext.fillText(showText, textX, textY);
    }

    function drawTracks() {
      for (var numOfRow = 0; numOfRow < TRACK_ROWS; numOfRow++) {
        var y = (TRACK_HEIGHT + TRACK_GAP) * numOfRow + TRACK_GAP;
        for (var numOfCol = 0; numOfCol < TRACK_COLS; numOfCol++) {
          var x = (TRACK_WIDTH + TRACK_GAP) * numOfCol + TRACK_GAP;
          if ( trackGrid[numOfRow * TRACK_COLS + numOfCol] == 1) {
            colorRect(x, y, TRACK_WIDTH, TRACK_HEIGHT, "blue");
          } 
        }
      }
    }

    function drawBitmapCenteredWithRotation( useBitmap, atX, atY, withAng ) {
      canvasContext.save();
      canvasContext.translate(atX, atY);
      canvasContext.rotate(withAng);
      canvasContext.drawImage(useBitmap, -useBitmap.width / 2, -useBitmap.height / 2);
      canvasContext.restore();
    }

    function drawEverything() {
      colorRect(0, 0, canvas.width, canvas.height, '#000');

      if (carPicLoaded) {
        drawBitmapCenteredWithRotation(carPic, carX, carY, carAng);
      }

      drawTracks();
    }

    function carMove() {
      carAng += 0.02;
      carX += Math.cos(carAng) * carSpeed;
      carY += Math.sin(carAng) * carSpeed;
    }

    function colRowToArrayIndex(col, row) {
      var trackIndexUnderCar = ((row - 1) * TRACK_COLS + col) - 1;
      return trackIndexUnderCar;
    }

    function isTrackAtColRow(col, row) {
      var index = colRowToArrayIndex(col, row);
      if ( index < trackGrid.length &&      //*  check if the brick is inside the field
           col >= 1 && col <= TRACK_COLS && //** check for fixing bug with opposite edge removing
           row >= 1 && row <= TRACK_ROWS && //**
           trackGrid[colRowToArrayIndex(col, row)] == 1 ) //*** check if the brick is visible
        return true;
      else
        return false;
    }

    function getColFromX(x) {
      return Math.floor(x / (TRACK_WIDTH + TRACK_GAP) + 1);
    }

    function getRowFromY(y) {
      return Math.floor(y / (TRACK_HEIGHT + TRACK_GAP) + 1);
    }

    function carTrackHandling() {
      var trackCol = getColFromX(carX);
      var trackRow = getRowFromY(carY);
      var trackIndex = colRowToArrayIndex(trackCol, trackRow);
      if ( isTrackAtColRow(trackCol, trackRow) ) {
        carSpeed *= -1;          
      }
    } 

    function moveEverything() {
      carMove();
      carTrackHandling();
    }

  </script>

</body>
</html>