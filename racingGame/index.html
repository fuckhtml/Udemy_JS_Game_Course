<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tennis Game</title>
</head>
<body>
  <canvas id="gameCanvas" width="815" height="590"></canvas>
  <script>
//    debugger;
    var canvas;
    var canvasContext;

    // Ball's settings
    var ballX;
    var ballY;
    var ballSpeedX = 3;
    var ballSpeedY = 3;

    // Track's settings
    const TRACK_WIDTH = 40;
    const TRACK_HEIGHT = 40;
    const TRACK_GAP = 5;
    const TRACK_COLS = 18;
    const TRACK_ROWS = 13;
    var trackGrid = [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ];
    var tracksLeft = 0;

    // Mouse settings
    var mouseX = 400;
    var mouseY;

    window.onload = function() {
      // save the canvas for dimensions, and its 2d context for drawing to it
      canvas = document.getElementById("gameCanvas");
      canvasContext = canvas.getContext('2d');

      ballReset();

      canvas.addEventListener('mousemove', updateMousePos);


      var fps = 30;
      setInterval(updateAll, 1000 / fps);
    }

    function ballReset() {
      ballX = canvas.width / 2;
      ballY = canvas.height / 2;
    }

    function updateAll() {
      drawEverything();
      moveEverything();
    };

    function updateMousePos(event) {
       var rect = canvas.getBoundingClientRect();
       var root = document.documentElement;

       mouseX = event.clientX - rect.left - root.scrollLeft
       mouseY = event.clientY - rect.top - root.scrollTop;

       // cheat / to check for bugs 
       /*
       ballX = mouseX;
       ballY = mouseY;
       */
    }

    function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
      canvasContext.fillStyle = fillColor;
      canvasContext.beginPath();
      canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
      canvasContext.fill();
    }

    function colorCircle(centerX, centerY, radius, fillColor) {
      canvasContext.fillStyle = fillColor;
      canvasContext.beginPath();
      canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
      canvasContext.fill();
    }

    function colorText(showText, textX, textY, fillColor) {
      canvasContext.fillStyle = fillColor;
      canvasContext.fillText(showText, textX, textY);
    }

    function drawTracks() {
      for (var numOfRow = 0; numOfRow < TRACK_ROWS; numOfRow++) {
        var y = (TRACK_HEIGHT + TRACK_GAP) * numOfRow + TRACK_GAP;
        for (var numOfCol = 0; numOfCol < TRACK_COLS; numOfCol++) {
          var x = (TRACK_WIDTH + TRACK_GAP) * numOfCol + TRACK_GAP;
          if ( trackGrid[numOfRow * TRACK_COLS + numOfCol] == 1) {
            colorRect(x, y, TRACK_WIDTH, TRACK_HEIGHT, "blue");
          }
        }
      }
    }

    function drawEverything() {
      colorRect(0, 0, canvas.width, canvas.height, '#000');

      colorCircle(ballX, ballY, 10, '#fff');

      drawTracks();
    }

    function ballMove() {
      ballX += ballSpeedX;
      ballY += ballSpeedY;

      // reflects a ball from canvas adges
      if ( ballX < 0 && ballSpeedX < 0.0) ballSpeedX *= -1;
      if ( ballX > canvas.width && ballSpeedX > 0.0) ballSpeedX *= -1;
      if ( ballY < 0 && ballSpeedY < 0.0) ballSpeedY *= -1;
      if ( ballY > canvas.height ) ballSpeedY *= -1;
    }

    function colRowToArrayIndex(col, row) {
      var trackIndexUnderBall = ((row - 1) * TRACK_COLS + col) - 1;
      return trackIndexUnderBall;
    }

    function isTrackAtColRow(col, row) {
      var index = colRowToArrayIndex(col, row);
      if ( index < trackGrid.length &&      //*  check if the brick is inside the field
           col >= 1 && col <= TRACK_COLS && //** check for fixing bug with opposite edge removing
           row >= 1 && row <= TRACK_ROWS && //**
           trackGrid[colRowToArrayIndex(col, row)] == 1 ) //*** check if the brick is visible
        return true;
      else
        return false;
    }

    function getColFromX(x) {
      return Math.floor(x / (TRACK_WIDTH + TRACK_GAP) + 1)
    }

    function getRowFromY(y) {
      return Math.floor(y / (TRACK_HEIGHT + TRACK_GAP) + 1)
    }

    function ballTrackHandling() {
      var trackCol = getColFromX(ballX);
      var trackRow = getRowFromY(ballY);
      var trackIndex = colRowToArrayIndex(trackCol, trackRow);
      if ( isTrackAtColRow(trackCol, trackRow) ) {
          //  where to reflect the ball
          var prevBallX = ballX - ballSpeedX;
          var prevBallY = ballY - ballSpeedY;
          var prevTrackCol = Math.floor(prevBallX / (TRACK_WIDTH + TRACK_GAP) + 1);
          var prevTrackRow = Math.floor(prevBallY / (TRACK_HEIGHT + TRACK_GAP) + 1);

          if (prevTrackCol != trackCol) ballSpeedX *= -1;
          if (prevTrackRow != trackRow) ballSpeedY *= -1;
      }
    } 

    function moveEverything() {
      ballMove();
      ballTrackHandling();
    }

  </script>
</body>
</html>